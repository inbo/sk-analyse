---
title: "Conform_old_afvangsten_to_new"
author: "Sander Devisscher"
date: "2024-12-05"
output: html_document
---

```{r libraries}
library(rgbif)
library(tidyverse)
```

```{r get credentials, include=FALSE}
gbif_email <- Sys.getenv("email")
gbif_pwd <- Sys.getenv("gbif_pwd")
gbif_user <- Sys.getenv("gbif_user")
```

```{r get data from gbif, include=FALSE}
if(file.exists("./interim/afvangsten_raw_tot2018.csv")){
  reuse <- askYesNo("Do you want to use the existing data?", default = TRUE)
  
  if(reuse){
    rawData <- read_csv("./interim/afvangsten_raw_tot2018.csv")
    verbatimData <- read_csv("./interim/afvangsten_verbatim_tot2018.csv")
  } 
} else{
  reuse <- FALSE
}

if(!reuse){
  # Download data from GBIF
  datasetkeys <- c("ea95fd9b-58dc-4e48-b51f-9380e9804607")
  
  taxonkey <- c(2427091)
  
  gbif_downloadKey <- occ_download(pred_in("datasetKey", datasetkeys),
                                   pred("taxonKey", taxonkey),
                                   user = gbif_user,
                                   pwd = gbif_pwd,
                                   email = gbif_email,
                                   curlopts = list(verbose = TRUE,
                                                   http_version = 2,
                                                   forbid_reuse = TRUE))
  
  occ_download_wait(gbif_downloadKey,
                    curlopts = list(verbose = TRUE,
                                    http_version = 2,
                                    forbid_reuse = TRUE))
  # Execute download request
  gbif_download <- occ_download_get(gbif_downloadKey, 
                                    path = tempdir(), 
                                    overwrite = TRUE,
                                    curlopts = list(verbose = TRUE,
                                                    http_version = 2,
                                                    forbid_reuse = TRUE))
  
  rawData <- occ_download_import(x = gbif_download) %>% 
    mutate(gbifID = as.double(gbifID)) %>% 
    write_csv("./interim/afvangsten_raw_tot2018.csv")
  
  lifeStage_output <- data.frame()
  locality_output <- data.frame()
  
  extractDir <- file.path(tempdir(), "gbifdownload")
  utils::unzip(gbif_download[[1]], exdir = extractDir, overwrite = TRUE)
  verbatimFile <- list.files(extractDir, pattern = "verbatim", full.names = TRUE)
  verbatimData <- read.table(file = verbatimFile, sep = "\t", header = TRUE) %>% 
    write_csv("./interim/afvangsten_verbatim_tot2018.csv")
}
```

```{r read afvangsten per fuik}
afvangsten_post2018 <- read_csv("./interim/afvangsten_per_fuik.csv")
```

```{r map lifestages}
verbatimData_until_2018 <- verbatimData %>% 
  dplyr::select(gbifID, lifeStage, verbatimLocality)

lifeStages_until_2018_int <- verbatimData_until_2018 %>% 
  dplyr::select(gbifID, lifeStage) %>% 
  separate(lifeStage, 
           sep = ";",
           into = c("stage1",
                    "stage2",
                    "stage3",
                    "stage4",
                    "stage5",
                    "stage6",
                    "stage7",
                    "stage8",
                    "stage9",
                    "stage10",
                    "stage11",
                    "stage12",
                    "stage13",
                    "stage14",
                    "stage15",
                    "stage16",
                    "stage17")) %>% 
  pivot_longer(cols = contains("stage"),
               names_to = "lifestage_nr",
               values_to = "lifeStage") %>% 
  dplyr::select(-lifestage_nr) %>% 
  mutate(lifeStage = str_remove(lifeStage, " "),
         lifeStage = str_remove(lifeStage, "lenght:")) %>% 
  separate(lifeStage, sep = ":",
           into = c("lifeStage2",
                    "n")) %>% 
  mutate(n = as.numeric(n)) %>% 
  filter(n != 0,
         !is.na(n)) %>% 
    mutate(lifeStage = case_when(grepl("female", lifeStage2) ~ "AV",
                               grepl("male", lifeStage2) ~ "AM",
                               lifeStage2 %in% c("larvae with hind legs < 1cm", "larvaewith hind legs < 1cm") ~ "L1",
                               lifeStage2 %in% c("larvae with hind legs > 1cm", "larvaewith hind legs > 1cm") ~ "L2",
                               lifeStage2 %in% c("larvae no legs", "larvaeno legs") ~ "L0",
                               lifeStage2 %in% c("metamorph without tail", "metamorphwithout tail") ~ "M2",
                               lifeStage2 %in% c("metamorph with tail", "metamorphwith tail") ~ "M1",
                               lifeStage2 %in% c("smallest larvae < 5cm no legs", "smallestlarvae < 5cm no legs") ~ "L00",
                               lifeStage2 %in% c("Juvenieloops", "Juveniel", "metamorph") ~ "MX",
                               lifeStage2 %in% c("adult", "adults") ~ "AX",
                               lifeStage2 %in% c("larvae", "larvae?", "lenght< 5 cm") ~ "LX",
                               TRUE ~ lifeStage2)) %>% 
  pivot_wider(id_cols = gbifID, names_from = lifeStage, values_from = n, values_fn = min, values_fill = NA) %>% 
  group_by(gbifID) %>%
  mutate(larven_fuik = sum(L0, L00, L1, L2, LX, na.rm = TRUE),
         totaal_fuik = sum(M1, M2, MX,AV, AM, AX, larven_fuik, na.rm = TRUE))
```

