---
title: "Conform_old_afvangsten_to_new"
author: "Sander Devisscher"
date: "2024-12-05"
output: html_document
---

```{r libraries}
library(rgbif)
library(fistools)
library(googlesheets4)
library(tidyverse)
```

```{r get credentials, include=FALSE}
gbif_email <- Sys.getenv("email")
gbif_pwd <- Sys.getenv("gbif_pwd")
gbif_user <- Sys.getenv("gbif_user")
```

```{r get data from gbif, include=FALSE}
if(file.exists("./interim/afvangsten_raw_tot2018.csv")){
  reuse <- askYesNo("Do you want to use the existing data?", default = TRUE)
  
  if(reuse){
    rawData <- read_csv("./interim/afvangsten_raw_tot2018.csv")
    verbatimData <- read_csv("./interim/afvangsten_verbatim_tot2018.csv")
  } 
} else{
  reuse <- FALSE
}

if(!reuse){
  # Download data from GBIF
  datasetkeys <- c("ea95fd9b-58dc-4e48-b51f-9380e9804607")
  
  taxonkey <- c(2427091)
  
  gbif_downloadKey <- occ_download(pred_in("datasetKey", datasetkeys),
                                   pred("taxonKey", taxonkey),
                                   user = gbif_user,
                                   pwd = gbif_pwd,
                                   email = gbif_email,
                                   curlopts = list(verbose = TRUE,
                                                   http_version = 2,
                                                   forbid_reuse = TRUE))
  
  occ_download_wait(gbif_downloadKey,
                    curlopts = list(verbose = TRUE,
                                    http_version = 2,
                                    forbid_reuse = TRUE))
  # Execute download request
  gbif_download <- occ_download_get(gbif_downloadKey, 
                                    path = tempdir(), 
                                    overwrite = TRUE,
                                    curlopts = list(verbose = TRUE,
                                                    http_version = 2,
                                                    forbid_reuse = TRUE))
  
  rawData <- occ_download_import(x = gbif_download) %>% 
    mutate(gbifID = as.double(gbifID)) %>% 
    write_csv("./interim/afvangsten_raw_tot2018.csv")
  
  lifeStage_output <- data.frame()
  locality_output <- data.frame()
  
  extractDir <- file.path(tempdir(), "gbifdownload")
  utils::unzip(gbif_download[[1]], exdir = extractDir, overwrite = TRUE)
  verbatimFile <- list.files(extractDir, pattern = "verbatim", full.names = TRUE)
  verbatimData <- read.table(file = verbatimFile, sep = "\t", header = TRUE) %>% 
    write_csv("./interim/afvangsten_verbatim_tot2018.csv")
}
```

```{r authenticate googlesheets}
gs4_auth(email = Sys.getenv("email"))
```

```{r read additional data}
vijvers_raw <- read_sheet(Sys.getenv("SK_FORMS"),
                          sheet = "Andere Vijvers") %>% 
  filter(!is.na(UUID))

vijvers_int <- vijvers_raw %>% 
  mutate(Locatie = tolower(Locatie)) %>% 
  separate(latlong, c("lat", 
                      "long"),
           ", ") %>% 
  mutate(lat = as.numeric(lat),
         long = as.numeric(long)) 

uitvoerders <- read_sheet(Sys.getenv("SK_FORMS"),
                          sheet = "Gebruikers",
                          col_types = "c") %>% 
  select(-Invuller)
```

```{r read grid}
eea_grid <- sf::st_read("https://github.com/inbo/aspbo/raw/refs/heads/uat/data/output/UAT_processing/grid/utm1_bel_with_regions.gpkg", layer = "utm1_bel_with_regions") %>% 
  select(CELLCODE, geom) %>% 
  sf::st_transform(4326) %>% 
  mutate(geometry = geom) %>%
  sf::st_centroid() %>% 
  mutate(lat_grid = sf::st_coordinates(geom)[,2],
         long_grid = sf::st_coordinates(geom)[,1]) %>% 
  sf::st_drop_geometry(geom) %>%
  sf::st_as_sf()
```

```{r read afvangsten per fuik}
afvangsten_post2018 <- read_csv("./interim/afvangsten_per_fuik.csv") %>% 
  mutate(AX = NA_integer_,
         LX = NA_integer_,
         MX = NA_integer_)
```

```{r map lifestages}
verbatimData_pre2018 <- verbatimData %>% 
  dplyr::select(gbifID, lifeStage, verbatimLocality)

lifeStages_pre2018 <- verbatimData_until_2018 %>% 
  dplyr::select(gbifID, lifeStage) %>% 
  separate(lifeStage, 
           sep = ";",
           into = c("stage1",
                    "stage2",
                    "stage3",
                    "stage4",
                    "stage5",
                    "stage6",
                    "stage7",
                    "stage8",
                    "stage9",
                    "stage10",
                    "stage11",
                    "stage12",
                    "stage13",
                    "stage14",
                    "stage15",
                    "stage16",
                    "stage17")) %>% 
  pivot_longer(cols = contains("stage"),
               names_to = "lifestage_nr",
               values_to = "lifeStage") %>% 
  dplyr::select(-lifestage_nr) %>% 
  mutate(lifeStage = str_remove(lifeStage, " "),
         lifeStage = str_remove(lifeStage, "lenght:")) %>% 
  separate(lifeStage, sep = ":",
           into = c("lifeStage2",
                    "n")) %>% 
  mutate(n = as.numeric(n)) %>% 
  filter(n != 0,
         !is.na(n)) %>% 
  mutate(lifeStage = case_when(grepl("female", lifeStage2) ~ "AV",
                               grepl("male", lifeStage2) ~ "AM",
                               lifeStage2 %in% c("larvae with hind legs < 1cm", "larvaewith hind legs < 1cm") ~ "L1",
                               lifeStage2 %in% c("larvae with hind legs > 1cm", "larvaewith hind legs > 1cm") ~ "L2",
                               lifeStage2 %in% c("larvae no legs", "larvaeno legs") ~ "L0",
                               lifeStage2 %in% c("metamorph without tail", "metamorphwithout tail") ~ "M2",
                               lifeStage2 %in% c("metamorph with tail", "metamorphwith tail") ~ "M1",
                               lifeStage2 %in% c("smallest larvae < 5cm no legs", "smallestlarvae < 5cm no legs") ~ "L00",
                               lifeStage2 %in% c("Juvenieloops", "Juveniel", "metamorph") ~ "MX",
                               lifeStage2 %in% c("adult", "adults") ~ "AX",
                               lifeStage2 %in% c("larvae", "larvae?", "lenght< 5 cm") ~ "LX",
                               TRUE ~ lifeStage2)) %>% 
  pivot_wider(id_cols = gbifID, names_from = lifeStage, values_from = n, values_fn = min, values_fill = NA) %>% 
  group_by(gbifID) %>%
  mutate(larven_fuik = sum(L0, L00, L1, L2, LX, na.rm = TRUE),
         totaal_fuik = sum(M1, M2, MX,AV, AM, AX, larven_fuik, na.rm = TRUE))
```

```{r map locations}
locations_pre2018 <- verbatimData_pre2018 %>% 
  dplyr::select(gbifID, verbatimLocality) %>% 
  mutate(fuikNr = str_extract(verbatimLocality, "Fuik [0-9]"),
         Locatie = case_when(!is.na(fuikNr) ~ str_replace(pattern = fuikNr,
                                                          replacement = "", 
                                                          string = verbatimLocality),
                             TRUE ~ verbatimLocality),
         Hoek = str_extract(verbatimLocality, "[0-9][0-9]Â°"),
         Locatie = case_when(!is.na(Hoek) ~ str_replace(pattern = Hoek,
                                                        replacement = "", 
                                                        string = Locatie),
                             TRUE ~ Locatie),
         Locatie = str_trim(tolower(Locatie))) %>% 
  left_join(vijvers_int, by = c("Locatie" = "Locatie")) %>% 
  select(gbifID,
         locationID = UUID,
         lat_vijver = lat,
         long_vijver = long,
         Locatie, 
         fuikNr,
         Hoek,
         Type) 

# Add lat_grid and long_grid
gridcells <- st_intersection(locations_pre2018 %>% 
                               filter(!is.na(lat_vijver),
                                      !is.na(long_vijver)) %>%
                               distinct(locationID, lat_vijver, long_vijver, Type) %>% 
                               st_as_sf(coords = c("long_vijver", "lat_vijver"), crs = 4326),
                             eea_grid) 
gridcells <- gridcells %>% 
  select(-CELLCODE) %>% 
  st_drop_geometry()

locations_pre2018 <- locations_pre2018 %>%
  left_join(gridcells, by = c("locationID" = "locationID")) 
```

```{r finalise mapping}
table(rawData$samplingProtocol)
table(afvangsten_post2018$actie)
table(afvangsten_post2018$Type)

afvangsten_pre2018 <- rawData %>% 
  filter(!samplingProtocol %in% c("field observation")) %>% 
  left_join(lifeStages_pre2018, by = "gbifID") %>% 
  left_join(locations_pre2018, by = "gbifID") %>% 
  rename(locationID = locationID.y,
         Datum = eventDate,
         Jaar = year) %>%
  mutate(Tijdstempel = NA_character_,
         actie = case_when(samplingProtocol == "Afschot" ~ "Afschot",
                           samplingProtocol %in% c("fike", "paired fyke nets",
                                                   "MC trap", "NV", "Pitfall Trap", 
                                                   "seine netting", "Dempen", "pumps") ~ "Afvangst",
                           TRUE ~ "Andere"),
         fuiklengte = NA_integer_,
         `Invuller 2` = NA_character_,
         `Net verhoogd?` = NA,
         Type = case_when("paired fyke nets")) %>%
  select(all_of(names(afvangsten_post2018)))
  
```

