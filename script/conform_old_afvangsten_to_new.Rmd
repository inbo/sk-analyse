---
title: "Conform_old_afvangsten_to_new"
author: "Sander Devisscher"
date: "2024-12-05"
output: html_document
---

```{r libraries}
library(rgbif)
library(tidyverse)
```

```{r get credentials, include=FALSE}
gbif_email <- Sys.getenv("email")
gbif_pwd <- Sys.getenv("gbif_pwd")
gbif_user <- Sys.getenv("gbif_user")
```

```{r get data from gbif, include=FALSE}
if(file.exists("./interim/afvangsten_raw_tot2018.csv")){
  reuse <- askYesNo("Do you want to use the existing data?", default = TRUE)
  
  if(reuse){
    rawData <- read_csv("./interim/afvangsten_raw_tot2018.csv")
    verbatimData <- read_csv("./interim/afvangsten_verbatim_tot2018.csv")
  } 
} else{
  reuse <- FALSE
}

if(!reuse){
  # Download data from GBIF
  datasetkeys <- c("ea95fd9b-58dc-4e48-b51f-9380e9804607")
  
  taxonkey <- c(2427091)
  
  gbif_downloadKey <- occ_download(pred_in("datasetKey", datasetkeys),
                                   pred("taxonKey", taxonkey),
                                   user = gbif_user,
                                   pwd = gbif_pwd,
                                   email = gbif_email,
                                   curlopts = list(verbose = TRUE,
                                                   http_version = 2,
                                                   forbid_reuse = TRUE))
  
  occ_download_wait(gbif_downloadKey,
                    curlopts = list(verbose = TRUE,
                                    http_version = 2,
                                    forbid_reuse = TRUE))
  # Execute download request
  gbif_download <- occ_download_get(gbif_downloadKey, 
                                    path = tempdir(), 
                                    overwrite = TRUE,
                                    curlopts = list(verbose = TRUE,
                                                    http_version = 2,
                                                    forbid_reuse = TRUE))
  
  rawData <- occ_download_import(x = gbif_download) %>% 
    mutate(gbifID = as.double(gbifID)) %>% 
    write_csv("./interim/afvangsten_raw_tot2018.csv")
  
  lifeStage_output <- data.frame()
  locality_output <- data.frame()
  
  extractDir <- file.path(tempdir(), "gbifdownload")
  utils::unzip(gbif_download[[1]], exdir = extractDir, overwrite = TRUE)
  verbatimFile <- list.files(extractDir, pattern = "verbatim", full.names = TRUE)
  verbatimData <- read.table(file = verbatimFile, sep = "\t", header = TRUE) %>% 
    write_csv("./interim/afvangsten_verbatim_tot2018.csv")
}
```

```{r read afvangsten per fuik}
afvangsten_post2018 <- read_csv("./interim/afvangsten_per_fuik.csv")
```
