# Stierkikker afvangsten datacleaning

Om dit script te laten lopen moet je een *.renviron* bestand aanmaken in de github map van deze repo (standaard vind je deze map in *C:\Users\%username%\Documents\GitHub\sk-analyse)* met daarin de volgende gegevens:

**email = "%je werk email%"**

Dit doen we om dat het bad practice is om email adressen en authenticatie in scripts te zetten. 

Je maakt dit type bestand door eerst in kladblok (of een andere tekstverwerker zoals notepad++) een bestandje aan te maken en vervolgens de extensie te veranderen in *.renviron*

# Setup
```{r libraries}
library(googlesheets4)
library(uuid)
library(rgbif)
library(dplyr)
library(readr)
library(magrittr)
library(tidyr)
library(tibble)
#library(tidylog)
```

get env variables to authenticate

```{r authenticate}
if(Sys.getenv("AUTOMATON") != ""){
  print("using actions environment")
  gs4_deauth()
}else{
  print("using local environment")
  gs4_auth(email = Sys.getenv("email"))
}
```

# Data
## General
```{r get data - rawdata}
rawdata <- read_sheet(Sys.getenv("SK_FORMS"),
                      sheet = "Formulierreacties 1",
                      col_types = "c") %>% 
  select(-contains("fuiken?"))
```

```{r get data - additional data}
vijvers_raw <- read_sheet(Sys.getenv("SK_FORMS"),
                          sheet = "Andere Vijvers") %>% 
  filter(!is.na(UUID))

vijvers_int <- vijvers_raw %>% 
  mutate(Locatie = tolower(Locatie)) %>% 
  separate(latlong, c("lat", 
                      "long"),
           ", ") %>% 
  mutate(lat = as.numeric(lat),
         long = as.numeric(long)) 

bijvangst <- read_sheet(Sys.getenv("BYCATCH"),
                        sheet = "Blad1",
                        col_types = "c")

uitvoerders <- read_sheet(Sys.getenv("SK_FORMS"),
                          sheet = "Gebruikers",
                          col_types = "c") %>% 
  select(-Invuller)
```

## Vijvers
```{r vervaging naar 1x1km EEA Grid}
eea_grid <- sf::st_read("https://github.com/inbo/aspbo/raw/refs/heads/uat/data/output/UAT_processing/grid/utm1_bel_with_regions.gpkg", layer = "utm1_bel_with_regions") %>% 
  select(CELLCODE, geom) %>% 
  sf::st_transform(4326) %>% 
  mutate(geometry = geom) %>%
  sf::st_centroid() %>% 
  mutate(lat_grid = sf::st_coordinates(geom)[,2],
         long_grid = sf::st_coordinates(geom)[,1]) %>% 
  sf::st_drop_geometry(geom) %>%
  sf::st_as_sf()

vijvers_zndr_coordinaten <- vijvers_int %>% 
  filter(is.na(lat) | is.na(long)) %>% 
  rename(lat_vijver = lat,
         long_vijver = long) %>%
  write_csv("./interim/vijvers_zndr_coordinaten.csv")

vijvers_int <- vijvers_int %>% 
  filter(!UUID %in% vijvers_zndr_coordinaten$UUID) %>%
  rename(lat_vijver = lat,
         long_vijver = long) %>%
  sf::st_as_sf(coords = c("long_vijver", "lat_vijver"), crs = 4326, remove = FALSE)

if(sf::st_crs(eea_grid) == sf::st_crs(vijvers_int)){
  vijvers_gridded <- sf::st_join(vijvers_int, eea_grid) %>% 
    sf::st_drop_geometry() %>% 
    select(-CELLCODE) %>% 
    bind_rows(vijvers_zndr_coordinaten %>% 
                mutate(lat_vijver = NA_real_,
                       long_vijver = NA_real_))
}

testthat::expect_true(nrow(vijvers_gridded) == nrow(vijvers_int) + nrow(vijvers_zndr_coordinaten))
```

## Combine datasets
```{r combine vijvers with actiedata}
#fix enkele gekende problemen 
data <- rawdata %>% 
  filter(!is.na(Tijdstempel)) %>% 
  mutate(Locatie = tolower(`Vijver - Andere`),
         Locatie = case_when(Locatie == "arendonk 2 b" ~ "arendonk 2b",
                             Locatie == "arendonk - visput" ~ "arendonk-visput",
                             Locatie == "sportcomplex heikant( gem. visvijver)" ~ "arendonk-visput",
                             Locatie == "arendonk sportcomplex" ~ "arendonk-visput",
                             TRUE ~ Locatie),
         `Fuik 1 - AV` = case_when(Tijdstempel == "23-5-2018 15:52:13" ~ "1",
                                   TRUE ~ `Fuik 1 - AV`),
         `Fuik 1 - Opmerkingen` = case_when(Tijdstempel == "23-5-2018 15:52:13" ~ "AV (poten niet meegeteld) 16cm",
                                            TRUE ~ `Fuik 1 - Opmerkingen`)) %>% 
  left_join(vijvers_gridded) %>% 
  rename(locationID = UUID)

#check join
not_linked <- data %>% 
  filter(is.na(locationID)) %>% 
  distinct(Locatie)

# Resterende niet gekoppelde acties zijn minder relevant (17/11: 24 acties)
```

```{r add uitvoerders}
dubbele_uitvoerders <- uitvoerders %>% 
  group_by(Email) %>% 
  filter(n() > 1) %>% 
  ungroup()

data <- data %>% 
  left_join(uitvoerders, by = c("E-mailadres" = "Email")) %>% 
  mutate(Organisation = case_when(is.na(Organisation) & Invuller == "kris meeus" ~ "Natuurwerk",
                                  is.na(Organisation) & Invuller == "Pieter Liekens" ~ "Natuurpunt",
                                  is.na(Organisation) & Invuller == "pieter liekens" ~ "Natuurpunt",
                                  `E-mailadres` == "smeetstimon@gmail.com" & 
                                    `Fuik 1 - Opmerkingen` == "Afvangst Vrijwilligers Natuurpunt" ~ "Natuurpunt",
                                  is.na(Organisation) ~ "Unknown",
                                  TRUE ~ Organisation))

Organisation_unknown <- data %>% 
  filter(Organisation %in% c("Unknown", "NA")) %>% 
  select(Tijdstempel, `E-mailadres`, Invuller, Organisation)

write_csv(Organisation_unknown, "./interim/Organisation_unknown.csv")

data <- data %>% 
  filter(!Organisation %in% c("Unknown", "NA"))
```

## Datacleaning

De correctie factor staat nu op in alle gevallen op 1. 
dmv case_when kan je conditioneel deze factor herberekenen.
voorbeeld:
mutate(correctie_factor = case_when(fuiktype == "enkele fuik" ~ 0.5,
fuiklengte == "13m" ~ 0.75,
TRUE ~ 1))

```{r datacleaning - general}
table(data$`Wat wil je melden`)

#verwijder niet gekoppelde acties & onnodige kolommen
data_afvangsten <- data %>% 
  filter(!is.na(locationID),
         grepl("Afvangst", `Wat wil je melden`))%>% 
  select(-contains("Vijver", ignore.case = FALSE), 
         -`E-mailadres`, 
         -`Aantal werknemers`,
         -Startuur,
         -Einduur,
         -contains("Bijvangst"),
         -Invuller,
         -eDNA_Status,
         -Latest_Update,
         -Laatste_vangst,
         -Larven,
         -`Post-Metamorfen`,
         -`Aantal fuiken geplaatst`,
         -`Start vangstperiode`,
         -`Eind vangstperiode`,
         -Gebied, 
         -Nummer) %>% 
  mutate(`Aantal fuiken (Totaal)` = as.numeric(`Aantal fuiken (Totaal)`))
```

```{r datacleaning: events - long}
# Selecteer events met Aantal fuiken (Totaal) == 1 & voeg eventID toe
# Deze events hebben data op meerdere rijen
# We tellen het aantal fuiken op en voegen eventID toe
data_afvangsten_long <- data_afvangsten %>% 
  filter(`Aantal fuiken (Totaal)` == 1) %>% 
  mutate(eventID = paste(Datum, Locatie, sep = "_")) %>% 
  group_by(eventID, `Wat wil je melden`) %>%
  mutate(`Aantal fuiken (Totaal)` = sum(as.numeric(`Aantal fuiken (Totaal)`), na.rm = TRUE)) %>% 
  ungroup()

# Check of de het max fuiknr groter is dan 1
# in dit geval is de data geen echte long data en moet aantal fuiken (totaal) herberekend worden
events_ids <- unique(data_afvangsten_long$eventID)

data_afvangsten_long_checked <- data.frame()

for(e in events_ids){
  temp <- data_afvangsten_long %>% 
    filter(eventID == e)
  
  fuiktypes <- unique(temp$`Wat wil je melden`)
  
  temp_recomb <- data.frame()
  
  for(f in fuiktypes){
    
    temp_sub <- temp %>% 
      filter(`Wat wil je melden` == f)
    
    # Extract columns with numbers in their name
    col_names <- names(temp_sub)[grepl("[0-9]", names(temp_sub))]
    
    # Drop columns with only NA's from col_names 
    col_names_no_na <- colnames(temp_sub)[apply(temp_sub, 2, function(x) any(!is.na(x)))]
    
    # Extract columns with Fuik in their name
    col_names_Fuik <- col_names_no_na[grepl("Fuik", col_names_no_na)]
    
    # Extract fuik numbers
    fuiknrs <- unique(as.numeric(gsub(".*?([0-9]+).*", "\\1", col_names_Fuik)))
    
    # Herbereken aantal fuiken (totaal) als max(fuiknr) > 1
    if(max(fuiknrs) > 1){
      print(e)
      print(nrow(temp_sub))
      
      if(nrow(temp_sub) == 1){
        # data in 1 rij -> multiply `Aantal fuiken (Totaal)` with max(fuiknr)
        temp_sub <- temp_sub %>% 
          filter(eventID == e) %>% 
          mutate(`Aantal fuiken (Totaal)` = `Aantal fuiken (Totaal)` * max(fuiknrs))
      }else{
        # data verspreid over meerdere rijen
        # iterate accross rows
        for(i in 1:nrow(temp_sub)){
          col_names_no_na <- colnames(temp_sub)[apply(temp_sub[i,], 2, function(x) any(!is.na(x)))]
          # Extract columns with Fuik in their name
          col_names_Fuik <- col_names_no_na[grepl("Fuik", col_names_no_na)]
          # Extract fuik numbers
          fuiknrs <- unique(as.numeric(gsub(".*?([0-9]+).*", "\\1", col_names_Fuik)))
          
          if(length(fuiknrs) > 1){
            print("different fuik numbers in 1 row")
            temp_sub[i,]$`Aantal fuiken (Totaal)` <- temp_sub[i,]$`Aantal fuiken (Totaal)` + (max(fuiknrs) - 1) 
          }
        }
        
        # # rowwise sum of fuiknrs + `Aantal fuiken (Totaal)`
        temp_sub <- temp_sub %>%
          group_by(eventID, `Wat wil je melden`) %>%
          mutate(`Aantal fuiken (Totaal)` = max(`Aantal fuiken (Totaal)`, na.rm = TRUE)) %>%
          ungroup()
      }
    }
    temp_recomb <- bind_rows(temp_recomb, temp_sub)
  }
  data_afvangsten_long_checked <- bind_rows(data_afvangsten_long_checked, temp_recomb)
}
```

```{r datacleaning: events - wide}
# Selecteer events met Aantal fuiken (Totaal) != 1 & voeg eventID toe
# Deze events hebben data verspreid over meerdere kolommen
data_afvangsten_wide <- data_afvangsten %>% 
  filter(`Aantal fuiken (Totaal)` != 1) %>% 
  mutate(eventID = paste(Datum, Locatie, sep = "_")) %>% 
  group_by(eventID) %>% 
  add_tally() %>%
  ungroup()

# Alle data van het event staat op 1 rij
data_afvangsten_wide_single <- data_afvangsten_wide %>%
  filter(n == 1) %>% 
  select(-n)

# Data van het event staat verspreid over meerdere rijen
# add column to flag whether or not `Aantal fuiken (Totaal)` > 12
data_afvangsten_wide_multiple <- data_afvangsten_wide %>%
  filter(n > 1) %>% 
  group_by(eventID) %>%
  mutate(flag = `Aantal fuiken (Totaal)` > 12) %>% 
  ungroup()


table(data_afvangsten_wide_multiple$flag)

# Type 1: Meer dan 12 fuiken
# De app laat een maximum van 12 fuiken toe
# Als er meer dan 12 fuiken zijn, dan is de data vermoedelijk verspreid over meerdere rijen
# `Aantal fuiken (Totaal)` is dan de som van de `Aantal fuiken (Totaal)` van de verschillende rijen
data_afvangsten_wide_multiple_1 <- data_afvangsten_wide_multiple %>% 
  filter(eventID %in% data_afvangsten_wide_multiple$eventID[data_afvangsten_wide_multiple$flag]) %>% 
  group_by(eventID, `Wat wil je melden`) %>%
  mutate(`Aantal fuiken (Totaal)` = sum(`Aantal fuiken (Totaal)`, na.rm = TRUE)) %>% 
  ungroup() %>% 
  select(-flag)

# Type 2: Minder dan 12 fuiken
# Vermoedelijk gaat het hier over een effectieve fout in de data
# In dit geval pakken we laatste versie van de data obv de tijdStempel
data_afvangsten_wide_multiple_2 <- data_afvangsten_wide_multiple %>% 
  filter(eventID %in% data_afvangsten_wide_multiple$eventID[data_afvangsten_wide_multiple$flag == FALSE]) %>% 
  group_by(eventID, `Wat wil je melden`) %>% 
  filter(Tijdstempel == max(Tijdstempel)) %>%
  ungroup() %>% 
  select(-flag)

data_afvangsten_wide_multiple_recomb <- rbind(data_afvangsten_wide_multiple_1,
                                              data_afvangsten_wide_multiple_2)

# combineer data
data_afvangsten_wide <- bind_rows(data_afvangsten_wide_single,
                                  data_afvangsten_wide_multiple_recomb)

table(data_afvangsten_wide$eventID, useNA = "ifany")
```

```{r datacleaning: events - combine}
# Combineer data
data_afvangsten <- bind_rows(data_afvangsten_wide,
                             data_afvangsten_long_checked) %>% 
  select(-n)
```

```{r datacleaning - eventstats}
events <- data_afvangsten %>% 
  group_by(eventID, `Wat wil je melden`) %>% 
  summarise(max_fuikNr = max(as.numeric(`Aantal fuiken (Totaal)`), na.rm = TRUE),
            no_fuiken = max(as.numeric(`Aantal fuiken (Totaal)`), na.rm = TRUE))
```

```{r datacleaning - afvangsten per fuik}
afvangsten_per_fuik <- data_afvangsten %>%  
  left_join(events, by = c("eventID", "Wat wil je melden")) %>% 
  filter(!is.na(Tijdstempel)) %>% 
  group_by(Datum, Locatie) %>% 
  pivot_longer(contains("Fuik", ignore.case = FALSE), 
               values_to = "value",
               values_ptypes = character()) %>% 
  filter(!is.na(value)) %>% 
  mutate(value = case_when(value == "-1" ~ as.character("NA"),
                           TRUE ~ value)) %>% 
  separate(name, c("fuikNr", "type"), " - ",
           convert = TRUE) %>% 
  pivot_wider(names_from = type, values_from = value) %>% 
  separate(`Wat wil je melden`, c("actie", 
                                  "fuiktype_1", 
                                  "fuiktype_2", 
                                  "fuiklengte"),
           convert = TRUE) %>% 
  ungroup() %>% 
  mutate(fuiktype_1 = case_when(is.na(fuiktype_1) & grepl(pattern = "bodem", 
                                                          Opmerkingen,
                                                          ignore.case = TRUE) ~ "salamanderfuik bodem",
                                is.na(fuiktype_1) & grepl(pattern = "drijvend", 
                                                          Opmerkingen,
                                                          ignore.case = TRUE) ~ "salamanderfuik drijvend",
                                TRUE ~ fuiktype_1),
         fuiktype = paste(fuiktype_1,
                          fuiktype_2)) %>% 
  select(-fuiktype_1,
         -fuiktype_2) %>%
  ungroup() %>% 
  mutate(L00 = as.numeric(L00),
         L0 = as.numeric(L0),
         L1 = as.numeric(L1),
         L2 = as.numeric(L2),
         M1 = as.numeric(M1),
         M2 = as.numeric(M2),
         AM = as.numeric(AM),
         AV = as.numeric(AV),
         Datum = as.Date(Datum, format = "%d-%m-%Y"),
         Tijdstempel = parse_datetime(Tijdstempel, format = "%d-%m-%Y %H:%M:%S"),
         fuikNr2 = as.numeric(gsub(pattern = "Fuik ",
                                   replacement = "",
                                   fuikNr))) %>% 
  ungroup()  %>% 
  group_by(Datum, Locatie, fuikNr, Hoek, fuiklengte, fuiktype, Tijdstempel) %>% 
  mutate(larven_fuik = sum(L00,L0,L1,L2, na.rm = TRUE),
         juveniel_fuik = sum(M1,M2, na.rm = TRUE),
         adult_fuik = sum(AM,AV, na.rm = TRUE),
         totaal_fuik = sum(L00,L0,L1,L2,M1,M2,AM,AV, na.rm = TRUE),
         correctie_factor = 1,
         larven_corrected = larven_fuik*correctie_factor,
         juveniel_corrected = juveniel_fuik*correctie_factor,
         adult_corrected = adult_fuik*correctie_factor,
         totaal_fuik_corrected = totaal_fuik*correctie_factor) %>% 
  ungroup() %>% 
  select(-`Aantal fuiken (Totaal)`) %>% 
  arrange(Datum, Locatie, fuikNr) %>% 
  mutate(max_fuikNr = case_when(is.infinite(max_fuikNr) ~ fuikNr2,
                                TRUE ~ max_fuikNr)) %>% 
  group_by(eventID, fuiktype) %>% 
  mutate(max_fuikNr = max(max_fuikNr, na.rm = TRUE),
         no_fuiken = max(no_fuiken, na.rm = TRUE))

# filter events with max_fuikNr > 1 & with only fuikNr == "Fuik 1"
# iterate every row to increase upto max_fuikNr
static_fuikNr <- afvangsten_per_fuik %>% 
  filter(fuikNr == "Fuik 1" & max_fuikNr > 1) %>% 
  group_by(eventID) %>% 
  add_tally() %>% 
  ungroup() %>% 
  filter(n > 1) %>% 
  filter(!fuiktype %in% c("salamanderfuik drijvend NA", "salamanderfuik bodem NA")) %>% 
  filter(!Datum == "2016-07-27") %>% 
  arrange(eventID, fuiktype)

events_ids <- unique(static_fuikNr$eventID)
temp_recomb <- data.frame()
temp_recomb2 <- data.frame()

for(e in events_ids){
  # extract data for event
  temp <- static_fuikNr %>% 
    filter(eventID == e)
  
  # extract fuiktypes
  fuiktypes <- unique(temp$fuiktype)
  
  for(f in fuiktypes){
    temp_sub <- temp %>% 
      filter(fuiktype == f)
    
    # iterate accross rows
    i <- 1
    
    max_fuikNr <- max(temp_sub$max_fuikNr)
    while(i <= max_fuikNr){
      print(paste0(i, "/", max_fuikNr))
      
      if(nrow(temp_sub[i,]) == 0){
        print("test")
      }
      
      temp_sub[i,] <- temp_sub[i,] %>% 
        mutate(fuikNr = paste("Fuik", i, sep = " "))
      i <- i + 1
    }
    
    if(NA %in% temp_sub$eventID){
      temp_sub <- temp_sub %>% 
        mutate(eventID = eventID[1],
               fuiktype = fuiktype[1],
               Tijdstempel = Tijdstempel[1],
               `Invuller 2` = `Invuller 2`[1],
               Datum = Datum[1],
               Jaar = Jaar[1],
               actie = actie[1],
               fuiklengte = fuiklengte[1],
               `Net verhoogd?` = `Net verhoogd?`[1],
               Type = Type[1],
               locationID = locationID[1],
               lat_vijver = lat_vijver[1],
               long_vijver = long_vijver[1],
               lat_grid = lat_grid[1],
               long_grid = long_grid[1],
               Organisation = Organisation[1],
               max_fuikNr = max_fuikNr[1],
               no_fuiken = no_fuiken[1],
               fuiktype = fuiktype[1],
               totaal_fuik = totaal_fuik[1],
               totaal_fuik_corrected = totaal_fuik_corrected[1],
               Locatie = Locatie[1])
    }
    temp_recomb <- bind_rows(temp_recomb, temp_sub)
    remove(temp_sub)
  }
}

temp_recomb <- temp_recomb %>% 
  mutate(fuiktype_event = paste(fuiktype, eventID, sep = "_")) 

static_fuikNr <- static_fuikNr %>% 
  mutate(fuiktype_event = paste(fuiktype, eventID, sep = "_"))

testthat::expect_true(nrow(events_missing <- static_fuikNr %>% 
                             filter(!eventID %in% temp_recomb$eventID)) == 0)

testthat::expect_true(nrow(locations_missing <- static_fuikNr %>% 
                             filter(!locationID %in% temp_recomb$locationID)) == 0)

testthat::expect_true(nrow(dates_missing <- static_fuikNr %>% 
                             filter(!Datum %in% temp_recomb$Datum)) == 0)

testthat::expect_true(nrow(fuiktype_event_missing <- static_fuikNr %>%
                             filter(!fuiktype_event %in% temp_recomb$fuiktype_event)) == 0)

static_fuikNr <- temp_recomb %>% 
  select(-fuiktype_event, -n)

dynamic_fuikNr <- afvangsten_per_fuik %>% 
  filter(!eventID %in% static_fuikNr$eventID)

afvangsten_per_fuik <- rbind(static_fuikNr,
                             dynamic_fuikNr)

false_zeroes <- afvangsten_per_fuik %>% 
  filter(fuikNr2 > max_fuikNr,
         totaal_fuik > 0)

afvangsten_per_fuik <- afvangsten_per_fuik %>% 
  filter(fuikNr2 <= max_fuikNr) %>% 
  dplyr::select(- fuikNr2,
                - max_fuikNr) %>% 
  ungroup()

# Check data per fuik
table(afvangsten_per_fuik$actie, useNA = "ifany")
table(afvangsten_per_fuik$fuiktype, useNA = "ifany") #NA's zijn meestal dubbele fuiken maar niet 100%

# set order of colums
afvangsten_per_fuik <- afvangsten_per_fuik %>% 
  select("Tijdstempel", "Invuller 2", "Datum", "Jaar", "Locatie", "actie", "fuiklengte", "Net verhoogd?", "lat_vijver", "long_vijver", "lat_grid", "long_grid", "Type", "locationID", "Organisation", "eventID", "no_fuiken", "fuikNr", "Opmerkingen", "L1", "L0", "L2", "M2", "AV", "AM", "L00", "M1", "Hoek", "fuiktype", "larven_fuik", "juveniel_fuik", "adult_fuik","totaal_fuik", "correctie_factor", "larven_corrected", "juveniel_corrected", "adult_corrected", "totaal_fuik_corrected") %>% 
  arrange(desc("Tijdstempel"))

#Export
write_csv(afvangsten_per_fuik, "./interim/afvangsten_per_fuik.csv")
```

```{r datacleaning - afvangsten per vangstdag}
afvangsten_per_vangst <- afvangsten_per_fuik %>% 
  group_by(Datum, Locatie, locationID, eventID) %>% 
  mutate(no_fuiken = case_when(is.na(no_fuiken) ~ as.numeric(n_distinct(fuikNr)),
                               no_fuiken == 0 ~ as.numeric(n_distinct(fuikNr)),
                               TRUE ~ no_fuiken)) %>% 
  summarise(larven_vangst = sum(larven_fuik, na.rm = TRUE),
            larven_vangst_corrected = sum(larven_corrected, na.rm = TRUE),
            totaal_vangst = sum(totaal_fuik, na.rm = TRUE),
            totaal_vangst_corrected = sum(totaal_fuik_corrected, na.rm = TRUE),
            no_fuiken = max(no_fuiken, na.rm = TRUE),
            cpue_larven = larven_vangst/no_fuiken,
            cpue_larven_corrected = larven_vangst_corrected/no_fuiken,
            cpue_totaal = totaal_vangst/no_fuiken,
            cpue_totaal_corrected = totaal_vangst_corrected/no_fuiken,
            Organisation = paste(unique(Organisation), collapse = " & ")) %>% 
  arrange(Datum, Locatie, locationID, eventID)

# Controle
n_distinct(afvangsten_per_fuik$Datum, afvangsten_per_fuik$Locatie) == nrow(afvangsten_per_vangst) #Moet TRUE zijn

table(afvangsten_per_vangst$Organisation, useNA = "ifany")

# Export
write_csv(afvangsten_per_vangst, "./interim/afvangsten_per_vangst.csv")
```

```{r datacleaning - afvangsten voor gbif}
afvangsten_vr_gbif_old <- read_csv("./output/gbif_stierkikker_vangsten.csv") %>% 
  dplyr::select(-Jaar,
                -`Net verhoogd?`)

afvangsten_vr_gbif <- afvangsten_per_fuik %>%
  filter(Jaar > 2018) %>% 
  rename(lat = lat_grid,
         long = long_grid) %>%
  select(-larven_fuik,
         -totaal_fuik,
         -correctie_factor,
         -larven_corrected,
         -totaal_fuik_corrected,
         -`Invuller 2`,
         -lat_vijver,
         -long_vijver) %>% 
  pivot_longer(cols = c("L00",
                        "L0",
                        "L1",
                        "L2",
                        "M1",
                        "M2",
                        "AM",
                        "AV"),
               names_to = "lifestage",
               values_to = "individualCount") %>% 
  ungroup() %>% 
  rowid_to_column(var = "rowid") %>% 
  mutate(scientificname = "Lithobates catesbeianus",
         taxonkey = 2427091,
         recordedBy = Organisation,
         identifiedBy = Organisation) %>% 
  filter(!is.na(individualCount)) %>% 
  dplyr::select(-Organisation) %>% 
  tidylog::left_join(afvangsten_vr_gbif_old, by = c("Tijdstempel" = "Tijdstempel",
                                                    "Datum" = "Datum",
                                                    "Locatie" = "Locatie",
                                                    "actie" = "actie",
                                                    "fuiklengte" = "fuiklengte",
                                                    "Type" = "Type",
                                                    "locationID" = "locationID",
                                                    "eventID" = "eventID",
                                                    "fuiktype" = "fuiktype",
                                                    "scientificname" = "scientificname",
                                                    "lifestage" = "lifestage",
                                                    "recordedBy" = "recordedBy",
                                                    "identifiedBy" = "identifiedBy",
                                                    "taxonkey" = "taxonkey")) %>% 
  rename(lat = lat.x,
         long = long.x,
         individualCount = individualCount.x,
         Hoek = Hoek.x,
         Opmerkingen = Opmerkingen.x,
         no_fuiken = no_fuiken.x,
         fuikNr = fuikNr.x) %>%
  dplyr::select(-lat.y,
                -long.y,
                -individualCount.y,
                -Hoek.y,
                -Opmerkingen.y,
                -no_fuiken.y,
                -fuikNr.y,
                -n)

afvangsten_vr_gbif <- afvangsten_vr_gbif %>% 
  group_by(rowid) %>% 
  add_tally() %>% 
  ungroup() 

names <- names(afvangsten_vr_gbif)
names <- names[!names %in% c("OccurrenceID")]

dups <- afvangsten_vr_gbif %>%
  filter(n > 1) %>%
  ungroup()

afvangsten_vr_gbif <- afvangsten_vr_gbif %>%
  filter(!occurrenceID %in% dups$occurrenceID)

# Duplicate occurrenceID's
# If a record is a real duplicate (all columns are the same), keep the first record
dups <- dups %>% 
  group_by_at(vars(-occurrenceID)) %>% 
  mutate(occurrenceID_old = c(paste(occurrenceID, collapse = ",")),
         occurrenceID = first(occurrenceID)) %>% 
  ungroup() %>% 
  distinct_at(vars(-occurrenceID_old), .keep_all = TRUE) %>% 
  select(-n) 


# If a record is not a real duplicate, keep all the records & add a new occurrenceID
remaining_dups_catch <- dups %>% 
  group_by(occurrenceID) %>% 
  add_tally() %>% 
  filter(n > 1) %>% 
  ungroup()


# Extract the records that were real duplicates => these are the records that are not in remaining_dups_catch
dups_catch_fixed <- dups %>% 
  filter(!occurrenceID %in% remaining_dups_catch$occurrenceID) %>% 
  ungroup()

# Add new occurrenceID to the remaining duplicates
remaining_dups_catch <- remaining_dups_catch %>% 
  group_by(occurrenceID) %>%
  mutate(occurrenceID = UUIDgenerate(n = n_distinct(rowid))) %>% 
  select(-occurrenceID_old) %>%
  ungroup()

# Combine the fixed duplicates with the remaining duplicates & the unique records
afvangsten_vr_gbif <- rbind(afvangsten_vr_gbif, dups_catch_fixed, remaining_dups_catch) %>%
  arrange(Tijdstempel) %>% 
  select(-n)
# ids <- unique(dups$eventID)
# 
# for(i in ids){
#   afvangsten_vr_gbif <- afvangsten_vr_gbif %>% 
#     filter(eventID != i)
# }
# 
# %>% 
#   group_by(eventID, Datum, lifestage, Jaar, Locatie, locationID, Tijdstempel,
#            actie, fuiklengte, `Net verhoogd?`, Type, lat, long, no_fuiken, fuikNr, Opmerkingen, Hoek,
#            fuiktype, scientificname, taxonkey, recordedBy, identifiedBy, occurrenceID) %>% 
#   summarise(individualCount = min(individualCount, na.rm = TRUE))

unis <- afvangsten_vr_gbif %>% 
  group_by(occurrenceID) %>%
  add_tally() %>%
  filter(n == 1)

afvangsten_vr_gbif <- afvangsten_vr_gbif %>% 
  tidylog::mutate(occurrenceID = case_when(is.na(occurrenceID) ~ UUIDgenerate(),
                                           TRUE ~ occurrenceID)) %>% 
  ungroup() %>% 
  dplyr::select(occurrenceID,Tijdstempel,Datum,Jaar,Locatie,actie,fuiklengte,`Net verhoogd?`,lat,long,Type,locationID,eventID,no_fuiken,fuikNr,Opmerkingen,Hoek,fuiktype,lifestage,individualCount,scientificname,taxonkey,recordedBy,identifiedBy)


# select the first row of every group
# afvangsten_vr_gbif <- afvangsten_vr_gbif %>%
#   group_by(eventID, Datum, lifestage, Jaar, Locatie, locationID, Tijdstempel,
#            actie, fuiklengte, `Net verhoogd?`, Type, lat, long, no_fuiken, fuikNr, Opmerkingen, Hoek,
#            fuiktype, scientificname, taxonkey, recordedBy, identifiedBy, occurrenceID) %>%
#   summarise(individualCount = min(individualCount, na.rm = TRUE))

duplis2 <- afvangsten_vr_gbif %>% 
  group_by(occurrenceID) %>%
  add_tally() %>%
  filter(n > 1) %>% 
  ungroup() %>% 
  distinct()

occurence_ids <- unique(duplis2$occurrenceID)

for(o in occurence_ids){
  temp <- duplis2 %>% 
    filter(occurrenceID == o)
  
  if(nrow(temp) > 1){
    temp <- temp %>% 
      filter(Tijdstempel == max(Tijdstempel))
    
    if(nrow(temp) > 1){
      temp <- temp[1,] 
    }
  }
  
  afvangsten_vr_gbif <- afvangsten_vr_gbif %>% 
    filter(occurrenceID != o)
  
  afvangsten_vr_gbif <- bind_rows(afvangsten_vr_gbif, temp)
  
}

events2 <- afvangsten_vr_gbif %>% 
  ungroup() %>% 
  distinct(Datum,
           Jaar,
           Locatie,
           actie,
           lat,
           long,
           locationID,
           eventID) 

testthat::expect_true(n_distinct(afvangsten_vr_gbif$occurrenceID) == nrow(afvangsten_vr_gbif))
testthat::expect_true(n_distinct(afvangsten_vr_gbif$eventID) == nrow(events2))
```

```{r}
missing_from_old <- afvangsten_vr_gbif_old %>% 
  filter(!occurrenceID %in% afvangsten_vr_gbif$occurrenceID) %>% 
  write_csv("./interim/missing_from_old.csv")

missing_from_new <- afvangsten_vr_gbif %>%
  filter(!occurrenceID %in% afvangsten_vr_gbif_old$occurrenceID) %>% 
  write_csv("./interim/missing_from_new.csv")

in_both <- afvangsten_vr_gbif %>% 
  filter(occurrenceID %in% afvangsten_vr_gbif_old$occurrenceID) %>% 
  write_csv("./interim/in_both.csv")
```

```{r datacleaning - bijvangsten vr gbif}
data_bijvangsten_old <- read_csv("./output/gbif_stierkikker_bijvangsten.csv") %>% 
  dplyr::select(-Jaar,
                -`Net verhoogd?`,
                -taxonkey)

data_bijvangsten <- data %>% 
  filter(!is.na(locationID),
         grepl("Afvangst", `Wat wil je melden`),
         Jaar > 2018) %>% 
  rename(lat = lat_grid,
         long = long_grid) %>%
  select(-contains("Vijver"), 
         -contains("fuiken"),
         -`E-mailadres`, 
         -`Aantal werknemers`,
         -Startuur,
         -Einduur,
         -contains("L00"),
         -contains("L0"),
         -contains("L1"),
         -contains("L2"),
         -contains("M1"),
         -contains("M2"),
         -contains("AV"),
         -contains("AM"),
         -Invuller,
         -eDNA_Status,
         -Latest_Update,
         -Laatste_vangst,
         -Larven,
         -`Post-Metamorfen`,
         -`Aantal fuiken geplaatst`,
         -`Start vangstperiode`,
         -`Eind vangstperiode`,
         -Gebied, 
         -Nummer) %>% 
  mutate(eventID = paste(Datum, Locatie, sep = "_")) %>% 
  left_join(events, by = c("eventID", "Wat wil je melden")) %>% 
  pivot_longer(contains("Fuik", ignore.case = FALSE), 
               values_to = "value",
               values_ptypes = character()) %>% 
  separate(name, c("fuikNr", "type"), " - ",
           convert = TRUE) %>% 
  pivot_wider(names_from = type, values_from = value) %>% 
  rename(species = 'Bijvangst [Soort]') %>% 
  mutate(species = gsub(pattern = "\\[|\\]",
                        replacement = "",
                        species)) %>% 
  separate(col = "species",
           into = c("species_0",
                    "species_1",
                    "species_2",
                    "species_3",
                    "species_4",
                    "species_5",
                    "species_6",
                    "species_7",
                    "species_8",
                    "species_9",
                    "species_10"),
           sep = ";") %>% 
  pivot_longer(cols = contains("species"),
               names_to = "species_nr",
               values_to = "species") %>% 
  select(-species_nr) %>% 
  filter(!is.na(species),
         species != "") %>% 
  left_join(bijvangst <- bijvangst %>% 
              select(Soort_Nieuw,
                     scientificname = Species),
            by = c("species" = "Soort_Nieuw")) %>% 
  select(-species) %>% 
  separate(`Wat wil je melden`, c("actie", 
                                  "fuiktype_1", 
                                  "fuiktype_2", 
                                  "fuiklengte"),
           convert = TRUE) %>% 
  ungroup() %>% 
  mutate(fuiktype_1 = case_when(is.na(fuiktype_1) & grepl(pattern = "bodem", 
                                                          Opmerkingen,
                                                          ignore.case = TRUE) ~ "salamanderfuik bodem",
                                is.na(fuiktype_1) & grepl(pattern = "drijvend", 
                                                          Opmerkingen,
                                                          ignore.case = TRUE) ~ "salamanderfuik drijvend",
                                TRUE ~ fuiktype_1),
         fuiktype = paste(fuiktype_1,
                          fuiktype_2)) %>%  
  select(-fuiktype_1,
         -fuiktype_2) %>% 
  ungroup() %>% 
  rowid_to_column(var = "rowid") %>% 
  mutate(lifestage = NA_character_,
         individualCount = NA_integer_) %>% 
  mutate(Datum = as.Date(Datum, format = "%d-%m-%Y"),
         Tijdstempel = parse_datetime(Tijdstempel, format = "%d-%m-%Y %H:%M:%S"),
         Hoek = as.character(Hoek),
         Opmerkingen = as.character(Opmerkingen),
         recordedBy = Organisation,
         identifiedBy = Organisation, 
         fuikNr2 = as.numeric(gsub(pattern = "Fuik ",
                                   replacement = "",
                                   fuikNr))) %>% 
  filter(fuikNr2 <= max_fuikNr) %>% 
  dplyr::select(-Organisation,
                -fuikNr2,
                -max_fuikNr) %>% 
  tidylog::left_join(data_bijvangsten_old, by = c("Tijdstempel" = "Tijdstempel",
                                                  "Datum" = "Datum",
                                                  "Locatie" = "Locatie",
                                                  "actie" = "actie",
                                                  "fuiklengte" = "fuiklengte",
                                                  "Type" = "Type",
                                                  "locationID" = "locationID",
                                                  "eventID" = "eventID",
                                                  "fuiktype" = "fuiktype",
                                                  "scientificname" = "scientificname",
                                                  "lifestage" = "lifestage",
                                                  "recordedBy" = "recordedBy",
                                                  "identifiedBy" = "identifiedBy")) %>% 
  rename(lat = lat.x,
         long = long.x,
         individualCount = individualCount.x,
         Hoek = Hoek.x,
         Opmerkingen = Opmerkingen.x,
         no_fuiken = no_fuiken.x,
         fuikNr = fuikNr.x) %>%
  dplyr::select(-lat.y,
                -long.y,
                -individualCount.y,
                -Hoek.y,
                -Opmerkingen.y,
                -no_fuiken.y,
                -fuikNr.y)


species <- unique(data_bijvangsten$scientificname)

temp_taxonkey <- data.frame() %>% 
  mutate(species = NA_character_,
         taxonkey = NA_integer_)

for(s in species){
  s2 <- gsub(pattern = "Distycus spec.",
             replacement = "Dytiscus",
             s)
  
  temp_lookup <- name_backbone(name = s2,
                               rank = "SPECIES")
  
  if("speciesKey" %in% names(temp_lookup)){
    temp_taxonkey <- temp_taxonkey %>% 
      add_row(species = s,
              taxonkey = temp_lookup$speciesKey)
  }else{
    temp_taxonkey <- temp_taxonkey %>% 
      add_row(species = s,
              taxonkey = temp_lookup$genusKey)
  }
  
}

data_bijvangsten <- data_bijvangsten %>% 
  left_join(temp_taxonkey,
            by = c("scientificname" = "species")) %>% 
  group_by(rowid) %>% 
  tidylog::mutate(occurrenceID = case_when(is.na(occurrenceID) ~ UUIDgenerate(),
                                           TRUE ~ occurrenceID)) %>% 
  ungroup() %>% 
  dplyr::select(-rowid,
                -`Invuller 2`, 
                occurrenceID,
                Tijdstempel,
                Datum,
                Locatie,
                actie,
                fuiklengte,
                lat,
                long,
                Type,
                locationID,
                eventID,
                no_fuiken,
                fuikNr,
                Hoek,
                Opmerkingen,
                scientificname,
                fuiktype,
                lifestage,
                individualCount,
                recordedBy,
                identifiedBy)

x <- names(afvangsten_vr_gbif)
y <- names(data_bijvangsten)

x_not_y <- setdiff(x, y)
y_not_x <- setdiff(y, x)

#max(str_count(data_bijvangsten$species, ";"), na.rm = TRUE)

table(data_bijvangsten$recordedBy,
      data_bijvangsten$identifiedBy,
      useNA = "ifany")

events3 <- data_bijvangsten %>% 
  ungroup() %>% 
  distinct(Datum,
           Jaar,
           Locatie,
           actie,
           lat,
           long,
           locationID,
           eventID) 

dup_bycatch <- data_bijvangsten %>% 
  group_by(occurrenceID) %>%
  add_tally() %>%
  filter(n > 1) %>% 
  ungroup() 

# reduce columns based on all columns except occurrenceID
dup_bycatch_redux <- dup_bycatch %>% 
  group_by_at(vars(-occurrenceID)) %>% 
  mutate(occurrenceID_old = c(paste(occurrenceID, collapse = ",")),
         occurrenceID = first(occurrenceID)) %>% 
  ungroup() %>% 
  distinct_at(vars(-occurrenceID_old), .keep_all = TRUE) %>% 
  select(-n)

# Remove remaining duplicates from data_bijvangsten
dup_bycatch_redux <- dup_bycatch_redux %>% 
  select(-occurrenceID_old) %>% 
  distinct(occurrenceID, .keep_all = TRUE) 

# Create a list of occurrenceIDs in dup_bycatch_redux$occurrenceID_old
occurence_ids <- unique(unlist(dup_bycatch$occurrenceID))

data_bijvangsten <- data_bijvangsten %>%
  filter(!occurrenceID %in% occurence_ids) 

data_bijvangsten <- bind_rows(data_bijvangsten, dup_bycatch_redux)

remaining_dup_bycatch <- data_bijvangsten %>% 
  group_by(occurrenceID) %>%
  add_tally() %>%
  filter(n > 1) %>% 
  ungroup()

testthat::expect_true(n_distinct(data_bijvangsten$occurrenceID) == nrow(data_bijvangsten))
testthat::expect_true(n_distinct(data_bijvangsten$eventID) == nrow(events3))
```

```{r filter data currently published}
afvangsten_vr_gbif <- afvangsten_vr_gbif %>% 
  filter(Datum < "2024-08-01")

data_bijvangsten <- data_bijvangsten %>%
  filter(Datum < "2024-08-01")
```

```{r datacleaning - export dfs vr gbif}
write_csv(afvangsten_vr_gbif, "./output/gbif_stierkikker_vangsten.csv")
write_csv(data_bijvangsten, "./output/gbif_stierkikker_bijvangsten.csv")
```

Plot data on a map
```{r}
library(leaflet)

# Create a map
m <- leaflet() %>% 
  addTiles() 
# Add markers
m <- m %>% 
  addCircles(data = afvangsten_vr_gbif,
             lat = ~lat,
             lng = ~long,
             radius = 5,
             color = "red",
             stroke = FALSE,
             fillOpacity = 0.5,
             popup = ~occurrenceID)
```

```{r EXTRA: combineer met pre2018 data}
afvangsten_per_fuik_pre2018 <- read_csv("interim/afvangsten_per_fuik_pre2018.csv")

afvangsten_per_fuik <- afvangsten_per_fuik %>% 
  mutate(MX = NA_integer_,
         AX = NA_integer_,
         LX = NA_integer_,
         Datum = as.character(Datum),
         Jaar = as.integer(Jaar))

afvangsten_per_fuik_combined <- bind_rows(afvangsten_per_fuik_pre2018, afvangsten_per_fuik)

write_csv(afvangsten_per_fuik_combined, "interim/afvangsten_per_fuik_combined.csv")
```

